import os
import requests
import json
import urllib3
import pandas as pd

# Disable SSL warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Set up proxies
http_proxy = os.environ.get('HTTP_PROXY')
https_proxy = os.environ.get('HTTPS_PROXY')
proxies = {
    "http": http_proxy,
    "https": https_proxy
}

def compute_flights():
    try:
        response = requests.get(
            url='https://opensky-network.org/api/states/all',
            proxies=proxies,
            verify=False,
            timeout=25
        )
        states_json = response.json()['states']
    except Exception as e:
        states_json = [{'icao24': str(e)}]

    df = pd.DataFrame(
        data=states_json,
        columns=['icao24', 'callsign', 'origin_country', 'time_position', 'last_contact',
                 'longitude', 'latitude', 'baro_altitude', 'on_ground', 'velocity',
                 'true_track', 'vertical_rate', 'sensors', 'geo_altitude', 'squawk',
                 'spi', 'position_source']
    ).set_index('icao24')

    return df[df['origin_country'] == 'Mexico'].to_dict(orient='list')

# Main execution
if __name__ == "__main__":
    result = compute_flights()
    print(json.dumps(result, indent=2))