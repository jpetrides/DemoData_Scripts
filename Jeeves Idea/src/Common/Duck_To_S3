import duckdb
import boto3
import os
from botocore.exceptions import ClientError

# DuckDB and table details
duckdb_path = "/Users/jpetrides/Documents/Demo Data/Hotels/Jeeves Idea/data/hotel_reservations.duckdb"
table_name = "hotel_reservations.main.Dim_Slots_Machines"

# S3 details
aws_access_key_id = 'AKIA2UC3EHDVWGYCA7P6'
aws_secret_access_key = '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'
s3_bucket_name = 'tableauprepstage'
s3_file_name = 'Dim_Slots_Machines.parquet'

# Local file path for temporary storage
local_file_path = 'temp_parquet.parquet'

# Connect to DuckDB
conn = duckdb.connect(duckdb_path)

try:
    # Export table to local Parquet file
    conn.execute(f"COPY {table_name} TO '{local_file_path}' (FORMAT PARQUET)")
    print(f"Table exported to {local_file_path}")

    # Upload file to S3
    s3_client = boto3.client(
        's3',
        aws_access_key_id=aws_access_key_id,
        aws_secret_access_key=aws_secret_access_key
    )

    s3_client.upload_file(local_file_path, s3_bucket_name, s3_file_name)
    print(f"File uploaded to S3: s3://{s3_bucket_name}/{s3_file_name}")

except ClientError as e:
    print(f"An error occurred: {e}")

finally:
    # Close DuckDB connection
    conn.close()

    # Delete local file
    if os.path.exists(local_file_path):
        os.remove(local_file_path)
        print(f"Local file {local_file_path} deleted")

print("Process completed")